# Wall2CAD - 이미지 세그멘테이션 기반 벡터 변환 도구

## 1. 프로젝트 개요

### 1.1 목적
SAM(Segment Anything Model) 기술을 활용하여 이미지에서 자동으로 객체를 세그멘테이션하고, 이를 CAD에서 사용 가능한 DXF 벡터 파일로 변환하는 사용자 친화적인 데스크톱 애플리케이션 개발

### 1.2 핵심 기능
- 이미지 자동 세그멘테이션 (SAM 모델 활용)
- 실시간 벡터 미리보기 및 편집
- DXF 파일 내보내기
- 2D CAD 스타일 사용자 인터페이스
- 배치 처리 지원

### 1.3 대상 사용자
- 건축가 및 설계자
- 엔지니어링 전문가
- CAD 작업자
- 도면 디지털화 작업자

## 2. 기술 스택

### 2.1 Frontend (UI)
- **PyQt6**: 메인 GUI 프레임워크
- **PyOpenGL**: 2D 벡터 렌더링 (CAD 스타일 뷰포트)
- **matplotlib**: 정적 이미지 표시 및 분석

### 2.2 Backend (Core Logic)
- **PyTorch**: SAM 모델 추론
- **OpenCV**: 이미지 처리 및 전처리
- **ezdxf**: DXF 파일 생성 및 편집
- **numpy**: 수치 연산

### 2.3 배포
- **PyInstaller**: 독립 실행 파일 생성
- **NSIS**: Windows 설치 프로그램 (선택적)

## 3. 아키텍처 설계

### 3.1 모듈 구조
```
Wall2CAD/
├── main.py                 # 애플리케이션 진입점
├── ui/
│   ├── main_window.py      # 메인 윈도우
│   ├── viewport.py         # CAD 스타일 뷰포트
│   ├── property_panel.py   # 속성 패널
│   └── toolbar.py          # 도구모음
├── core/
│   ├── sam_processor.py    # SAM 모델 처리
│   ├── image_loader.py     # 이미지 로딩
│   ├── mask_processor.py   # 마스크 후처리
│   └── dxf_exporter.py     # DXF 변환
├── utils/
│   ├── config.py           # 설정 관리
│   └── logger.py           # 로깅
└── resources/
    ├── models/             # SAM 모델 파일
    └── icons/              # UI 아이콘
```

### 3.2 데이터 플로우
```
Image Input → SAM Processing → Mask Generation → 
Vector Conversion → UI Rendering → DXF Export
```

## 4. 주요 기능 명세

### 4.1 이미지 관리
- **지원 포맷**: JPG, PNG, BMP, TIFF
- **드래그 앤 드롭** 지원
- **이미지 전처리**: 회전, 크기 조정, 밝기/대비
- **배치 처리**: 폴더 단위 일괄 처리

### 4.2 세그멘테이션 제어
- **SAM 모델 선택**: vit_b, vit_l, vit_h
- **파라미터 조정**:
  - points_per_side (그리드 밀도)
  - pred_iou_thresh (품질 임계값)
  - stability_score_thresh (안정성 임계값)
  - min_mask_region_area (최소 영역 크기)

### 4.3 벡터 편집 기능
- **실시간 미리보기**: 세그멘테이션 결과 즉시 확인
- **벡터 후처리**:
  - 스무딩 (Douglas-Peucker 알고리즘)
  - 노이즈 제거
  - 구멍 채우기
- **수동 편집**:
  - 개별 벡터 선택/삭제
  - 포인트 편집
  - 레이어 관리

### 4.4 2D CAD 뷰포트
- **확대/축소**: 마우스 휠, 단축키
- **패닝**: 마우스 드래그
- **그리드 표시**: 좌표 참조
- **측정 도구**: 거리, 면적 계산
- **레이어 관리**: 색상, 가시성 제어

### 4.5 내보내기 옵션
- **DXF 버전**: R12, R2000, R2010, R2018
- **단위 설정**: mm, cm, m, inch
- **좌표계**: 이미지 픽셀 → 실제 단위 변환
- **레이어 구성**: 객체별 자동 레이어 분류

## 5. UI/UX 설계

### 5.1 메인 레이아웃
```
+--------------------------------------------------+
| Menu Bar                                         |
+--------------------------------------------------+
| Tool Bar                        | Property Panel |
+----------------------------------+----------------+
| Image/Vector Viewport            | Settings Panel |
| (OpenGL 2D Canvas)               | - SAM Params   |
|                                  | - Export Opts  |
|                                  | - Layer Mgmt   |
+----------------------------------+----------------+
| Status Bar (Progress, Coords)                    |
+--------------------------------------------------+
```

### 5.2 워크플로우
1. **이미지 로드** → 썸네일 미리보기
2. **SAM 처리** → 진행률 표시
3. **결과 확인** → 오버레이 표시
4. **파라미터 조정** → 실시간 업데이트
5. **벡터 편집** → CAD 스타일 도구
6. **DXF 내보내기** → 저장 위치 선택

### 5.3 사용성 개선
- **키보드 단축키**: 일반적인 CAD 단축키 지원
- **상황별 도움말**: 툴팁 및 상태바 가이드
- **설정 저장**: 사용자 기본 설정 유지
- **실행 취소/복원**: 편집 히스토리 관리

## 6. 성능 최적화

### 6.1 SAM 모델 최적화
- **모델 캐싱**: 메모리에 모델 유지
- **CUDA 활용**: GPU 가속 처리
- **배치 처리**: 여러 이미지 동시 처리
- **비동기 처리**: UI 블로킹 방지

### 6.2 메모리 관리
- **이미지 스트리밍**: 큰 이미지 부분 로딩
- **벡터 압축**: 불필요한 포인트 제거
- **가비지 컬렉션**: 메모리 누수 방지

## 7. 개발 일정

### Phase 1: 핵심 기능 (4주)
- [x] 기본 UI 구조 구현 (완료 - PyQt6 기반)
- [ ] SAM 모델 통합 (진행중)
- [x] 이미지 로딩 및 표시 (완료)
- [ ] 기본 세그멘테이션 처리

### Phase 2: 벡터 처리 (3주)
- [ ] 벡터 변환 로직
- [ ] DXF 내보내기 기능
- [ ] 2D 뷰포트 구현
- [ ] 기본 편집 도구

### Phase 3: 고급 기능 (3주)
- [ ] 파라미터 조정 UI
- [ ] 벡터 후처리 옵션
- [ ] 배치 처리 기능
- [ ] 성능 최적화

### Phase 4: 폴리싱 (2주)
- [ ] UI/UX 개선
- [ ] 버그 수정
- [ ] 문서화
- [ ] 배포 준비

## 8. 기술적 고려사항

### 8.1 SAM 모델 관리
- **모델 파일 크기**: 2.4GB (vit_h) - 다운로드 및 저장 전략 필요
- **초기 로딩 시간**: 약 10-15초 - 스플래시 화면으로 대응
- **메모리 사용량**: 6-8GB - 시스템 요구사항 명시

### 8.2 호환성
- **운영체제**: Windows 10+, macOS 10.14+, Ubuntu 18.04+
- **Python 버전**: 3.8+
- **GPU 요구사항**: CUDA 11.0+ (선택적, CPU도 지원)

### 8.3 배포 전략
- **실행파일 크기**: 예상 500MB+ (모델 포함)
- **설치 프로그램**: 의존성 자동 설치
- **업데이트 시스템**: 자동 업데이트 확인

## 9. 테스트 계획

### 9.1 단위 테스트
- SAM 모델 추론 정확성
- DXF 변환 무결성
- UI 컴포넌트 기능

### 9.2 통합 테스트
- 전체 워크플로우 검증
- 성능 벤치마킹
- 메모리 누수 검사

### 9.3 사용자 테스트
- 다양한 이미지 타입 테스트
- 사용성 평가
- 버그 리포팅

## 10. 위험 요소 및 대응

### 10.1 기술적 위험
- **SAM 모델 성능**: 특정 이미지에서 품질 저하 → 파라미터 튜닝 옵션 제공
- **메모리 부족**: 대용량 이미지 처리 → 스트리밍 및 청킹
- **호환성 문제**: 다양한 시스템 환경 → 철저한 테스트

### 10.2 사용자 위험
- **학습 곡선**: CAD 인터페이스 복잡성 → 튜토리얼 및 가이드
- **성능 기대치**: 완벽한 자동화 기대 → 수동 편집 옵션 제공

## 11. 향후 확장 계획

### 11.1 고급 기능
- **AI 기반 후처리**: 벡터 스무딩 및 최적화
- **클라우드 처리**: 대용량 배치 작업
- **플러그인 시스템**: 사용자 정의 확장

### 11.2 통합 옵션
- **CAD 소프트웨어 플러그인**: AutoCAD, SolidWorks 연동
- **웹 버전**: 브라우저 기반 경량 버전
- **모바일 앱**: 간단한 처리용 모바일 버전

## 12. 현재 개발 상태 (2025-08-26)

### 12.1 완료된 기능
- ✅ **PyQt6 기반 UI 구조**: MainWindow, Viewport, PropertyPanel, MainToolBar
- ✅ **이미지 로딩 시스템**: ImageLoader 클래스, 다중 포맷 지원
- ✅ **이미지 표시 기능**: Viewport에서 이미지 렌더링, 확대/축소/패닝
- ✅ **CAD 스타일 뷰포트**: 그리드 표시, 마우스 인터랙션
- ✅ **UI 연결**: 메뉴바, 툴바, 시그널-슬롯 연결
- ✅ **SAM 매개변수 UI**: 실시간 조정 가능한 속성 패널

### 12.2 프로젝트 구조
```
Wall2CAD/
├── wall2cad_mvp/           # 기존 PyQt5 MVP 버전 (완성)
└── Wall2CAD/               # 새로운 PyQt6 버전 (개발중)
    ├── main.py             # ✅ 애플리케이션 진입점
    ├── ui/
    │   ├── main_window.py  # ✅ 메인 윈도우 UI
    │   ├── viewport.py     # ✅ CAD 스타일 뷰포트 
    │   ├── property_panel.py # ✅ SAM 매개변수 패널
    │   └── toolbar.py      # ✅ 메인 툴바
    ├── core/
    │   ├── image_loader.py # ✅ 이미지 로딩
    │   ├── sam_processor.py # 🔄 SAM 모델 처리 (미완성)
    │   ├── mask_processor.py # ❌ 마스크 후처리 (미구현)
    │   └── dxf_exporter.py  # ❌ DXF 변환 (미구현)
    └── utils/
        ├── config.py       # ❌ 설정 관리 (미구현)
        └── logger.py       # ❌ 로깅 (미구현)
```

### 12.3 현재 사용 가능한 기능
1. **이미지 파일 열기**: 파일 다이얼로그를 통한 이미지 로드
2. **이미지 표시**: 비율 유지하며 뷰포트에 표시
3. **확대/축소**: 마우스 휠 및 툴바 버튼
4. **패닝**: 중간 마우스 버튼으로 드래그
5. **그리드 토글**: 그리드 표시/숨김
6. **SAM 매개변수 UI**: 모델 선택, IoU 임계값 등 조정 가능

### 12.4 다음 개발 단계
1. **SAM 모델 통합**: core/sam_processor.py 완성
2. **마스크 처리**: 세그멘테이션 결과 시각화
3. **벡터 변환**: 마스크를 DXF 폴리라인으로 변환
4. **DXF 내보내기**: ezdxf를 사용한 파일 생성

### 12.5 기술적 변경사항
- **PyQt5 → PyQt6**: 최신 Qt 프레임워크 사용
- **개선된 아키텍처**: 모듈화된 구조로 재설계
- **향상된 UI**: CAD 스타일 인터페이스 개선
- **실시간 이미지 처리**: NumPy 배열 직접 처리

---

**작성일**: 2025-08-18  
**최종 업데이트**: 2025-08-26  
**버전**: 1.1  
**작성자**: AI Assistant